---
title: "Species Codon Adaptiveness"
output:
  html_document:
    df_print: paged
    code_folding: hide
    toc: yes
    toc_depth: '3'
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
date: "11/19/2020"
---

# Introduction  
The purpose of this document is to examine codon usage patterns at the genome-wide level and for user-defined gene-sets-of-interest, across four *Strongyloides spp.* and *C. elegans*. 

For the genes-of-interest, two groups are analyzed:  
1) Top 1% of codon adapted genes in each genome  
2) Bottom 1% of codon adapted genes in each genome

# Data Preprocessing  
Full lists of CDS sequences for *S. stercoralis*, *S. ratti*, *S. papillosus*, *S. venezuelensis* and *C. elegans* were download from Wormbase ParaSite (v15) on November 17, 2020. The .fa files were used as input to the *Strongyloides* Codon Adapter App. For each species an excel report containing the computed codon adaptation index values relative to *S. ratti* and *C. elegans* was downloaded; these file are uploaded the code chunks below.  

```{r setup, echo=FALSE}
suppressPackageStartupMessages({
  library(knitr)
  library(rmarkdown)
  library(tidyverse)
  library(readxl)
  library(magrittr)
  library(DescTools)
  library(ggthemes)
  library(biomaRt)
  library(ggplot2)
  library(openxlsx)
  library(wrapr)
  library(Matching)
  library(cowplot)
  library(gprofiler2)
  library(clusterProfiler)
  source('fetch_cDNAseq.R')
})
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Analysis/Results   

## Filter Genome Data  
For each species, load data listing GC content and CAI indeces for the full list of CDS elements in genome. The full list contains transcript level information. If downstream tidy version of this data is avliable or the filtered versions are avaliable as files, don't regenerate them. 
```{r filterGenomeData, message=FALSE}
if (!file.exists(c("./Data/Genomic/tidy_genomic_CAI.csv"))) {
  
  
  temp <- c(Ss = './Data/Genomic/Ss_Codon_Usage_Report.xlsx',
            Sr = './Data/Genomic/Sr_Codon_Usage_Report.xlsx',
            Sp = './Data/Genomic/Sp_Codon_Usage_Report.xlsx',
            Sv = './Data/Genomic/Sv_Codon_Usage_Report.xlsx',
            Ce = './Data/Genomic/Ce_Codon_Usage_Report.xlsx')
  dat.genomic <- sapply(temp, read_excel, 
                        sheet = 1, 
                        skip = 3, 
                        col_names = T, 
                        simplify = F, 
                        USE.NAMES = T)
  # This data contains transcript level information. 
  # Commented code would trim rows such that in cases where there are 
  # multiple transcripts per gene, only  
  # values from the longest transcript would be included.
  # This was originally included to permit comparison to gene expression databases
  # but is no longer required.
  dat.genomic.cleaned <- lapply(dat.genomic, function(x){
    x %>%
      dplyr::mutate(transcriptID = geneID)
    # dplyr::rename(transcriptID = geneID) %>%
    # dplyr::mutate(geneID = str_remove_all(transcriptID, "\\.[0-9]$")) %>%
    # dplyr::mutate(geneID = str_remove_all(geneID, "[a-c]$")) %>%
    # dplyr::group_by(geneID) %>%
    # dplyr::slice_max(n = 1, order_by = str_length(`cDNA sequence`), 
    #                   with_ties = FALSE) %>%
    #dplyr::relocate(geneID, .before = everything())
    
  })
  names(dat.genomic.cleaned) <- c("Ss", "Sr", "Sp", "Sv", "Ce")
  
}
```

## Tidy Genome Data 
Tidy the genomic CAI values for downstream plotting and analysis. This can be computationally intensive, so if the code is run, a tidy version will get saved at the end of the Markdown file as a .csv file. If that file exists, don't re-run this code.  
```{r loadGenomeData, message=FALSE}
if (!file.exists(c("./Data/Genomic/tidy_genomic_CAI.csv"))) {
  dat.genomic.df <- dat.genomic.cleaned %>%
    map("geneID") %>%
    unlist() %>%
    as_tibble_col(column_name = "geneID") %>%
    group_by(geneID)
  
  dat.genomic.df <- dat.genomic.cleaned %>%
    map("transcriptID") %>%
    unlist() %>%
    as_tibble_col(column_name = "transcriptID") %>%
    add_column(dat.genomic.df, .)
  
  dat.genomic.df <- dat.genomic.cleaned %>%
    map("Sr_CAI") %>%
    unlist() %>%
    as_tibble_col(column_name = "Sr_CAI") %>%
    add_column(dat.genomic.df, .)
  
  dat.genomic.df <- dat.genomic.cleaned %>%
    map("Ce_CAI") %>%
    unlist() %>%
    as_tibble_col(column_name = "Ce_CAI") %>%
    add_column(dat.genomic.df, .)
  
  dat.genomic.df <- dat.genomic.cleaned %>%
    map("GC") %>%
    unlist() %>%
    as_tibble_col(column_name = "GC") %>%
    add_column(dat.genomic.df, .)
  
  # Add the column that species which species the gene is from
  # by matching to the original lists of genes, 
  # the group
  dat.genomic.df <- dat.genomic.df %>%
    dplyr::mutate(species = case_when(
      transcriptID %in% dat.genomic$Ss$geneID ~ 'Ss',
      transcriptID %in% dat.genomic$Sr$geneID ~ 'Sr',
      transcriptID %in% dat.genomic$Sp$geneID ~ 'Sp',
      transcriptID %in% dat.genomic$Sv$geneID ~ 'Sv',
      transcriptID %in% dat.genomic$Ce$geneID ~ 'Ce',
    ))
  dat.genomic.df <- group_by(dat.genomic.df, species)
  
}

# Save a tidy version of the complied genomic CAI value dataset if it doesn't exist
if (!file.exists(c("./Data/Genomic/tidy_genomic_CAI.csv"))) {
  write.table(dat.genomic.df, 
              file = "./Data/Genomic/tidy_genomic_CAI.csv", 
              sep = ",", 
              col.names = T, 
              row.names = FALSE)
  
}
```

## CAI: Genome-wide Distribution Plot
This section takes the calculated codon adaptation index values for all predicted coding sequences, and generates a density curve for each species. Ideally, this plot could be used to benchmark the calculated CAI values against other metrics of codon bias in these species. For example, Mitreva *et al* 2006 reported effective number of codons (ENC) as a measure of gene-wise codon bias, across species. They report that "mean ENC across all sampled nemtaode species is 46.7 +/- 5.1" but that *S. stercoralis* and *S. ratti* are outliers with low ENC values (~35). Note: ENC values range from 20 for highly biased to 61 for no bias. Thus, benchmarking from Mitreva *et al* 2006, we might expect that *Strongyloides* species will have greater codon bias than *C. elegans*. Unfortunately, although they do report measuring distribution of ENC values across all transcripts for each species, they only have plots for *S. ratti*, *P. trichosuri* and *P. pacificus*.   
```{r caiDist}
dat.genomic.df <- suppressWarnings(
  read.csv("./Data/Genomic/tidy_genomic_CAI.csv", 
           header = TRUE)) %>%
  as_tibble() 

species.specific.dat.df <- dat.genomic.df %>%
  dplyr::mutate(species_CAI = case_when(
    species == 'Ce' ~ Ce_CAI,
    species != 'Ce' ~ Sr_CAI
  )) %>%
  dplyr::mutate(outgroup_CAI = case_when(
    species == 'Ce' ~ Sr_CAI,
    species != 'Ce' ~ Ce_CAI
  )) %>%
  #dplyr:: select(geneID, species_CAI, species) %>%
  group_by(species)


plot_distributions <- function(dat,
                               x,
                               title,
                               xlabel,
                               caption = "",
                               ylabel = "Density (scaled to maximum of 1)",
                               xlim = c(0,1),
                               ylim = c(0,1)) {
  dat %>%
    ggplot(aes(x = x, y = after_stat(ndensity), color = species)) +
    geom_freqpoly(bins = 50) +
    scale_color_manual(values = c("seagreen4", "steelblue4", 
                                  "coral4", "darkgoldenrod4", 
                                  "darkorchid4"),
                       name = "Species",
                       labels = c("C. elegans", "S. papillosus", 
                                  "S. ratti", "S. stercoralis",
                                  "S. venezuelensis")) +
    labs(title = title,
         subtitle = "Data includes all predicted coding sequences",
         x = xlabel,
         y = ylabel,
         caption = caption) +
    coord_equal(xlim = xlim, ylim = ylim) +
    theme_bw() +
    theme(plot.title.position = "plot",
          plot.caption.position = "panel",
          plot.title = element_text(face = "bold",
                                    size = 10, hjust = 0),
          plot.subtitle = element_text(size = 8),
          legend.title = element_text(size = 8),
          axis.title = element_text(size = 8),
          axis.text = element_text(size = 8),
          axis.text.x = element_text(angle = 45, hjust = 1))
}
species_adaptiveness_plot <- plot_distributions(species.specific.dat.df,
                                                species.specific.dat.df$species_CAI,
                                                "Species-wide codon adaptiveness",
                                                "Codon bias relative to \n genus coding usage rules (CAI)",
                                                "Strongyloides species values relative to S. ratti usage rules
       C. elegans values relative to C. elegans usage rules.")

species_adaptiveness_plot
```

Notes re: the above plot - *C. elegans* shows overall lower codon bias compared to the *Strongyloides* species, as predicted from the Mitreva *et al* 2006 results. Reminder that Mitreva *et al* reported that this difference is greatly affected by the GC content; more AT rich speices like the *Strongyloides* species have greater codon usage biases. Also, it looks like the *Strongyloides* subclades (*S. ratti* - *S. stercoralis*; *S. papillosus* - *S. venezuelensis*) cluster together.  

### Kruskal-Wallis Test with Dunn's Post tests for differences in genomic CAI values across species  
```{r genomic.CAI.kwtest}
# Kruskal-Wallis testing of genomic CAI
one.way <- kruskal.test(species_CAI ~ species, data = species.specific.dat.df)

# Posthoc Dunn tests with Bonferroni adjustment
post.hoc <- dunn.test::dunn.test(species.specific.dat.df$species_CAI, species.specific.dat.df$species, method = "bonferroni")
```

## GC: Genome-wide Distribution Plot
This section takes the calculated GC content values for all predicted coding sequences, and generates a density curve for each species.
```{r gcDist}

species.specific.GC.df <- dat.genomic.df %>%
  dplyr:: select(geneID, GC, species) %>%
  group_by(species)



species_GC_plot <- plot_distributions(species.specific.GC.df,
                                      species.specific.GC.df$GC,
                                      "Species-wide GC content",
                                      "GC content")

species_GC_plot
```

### Kruskal-Wallis Test with Dunn's Post tests for differences in genomic GC values across species  
```{r genomic.GC.kwtest}
# Kruskal-Wallis testing of genomic GC
one.way <- kruskal.test(GC ~ species, data = species.specific.GC.df)

# Posthoc Dunn tests with Bonferroni adjustment
post.hoc <- dunn.test::dunn.test(species.specific.GC.df$GC, species.specific.GC.df$species, method = "bonferroni")
```


## Analyze Codon Adaptation Index (CAI) values displayed by gene sets of interest  

### Pull Select Percentiles of Codon Adapted Genes  
Take genome-wide CAI values, and for each species filter the top 5% and also bottom 5% of codon adapted genes. Will run GO analysis on these to determine whether there are enriched GO Terms.  

```{r pullPercentiles}

percentile = 0.02

dat.Top <- species.specific.dat.df %>%
  #dplyr::filter(species != "Ce") %>%
  dplyr::mutate(Description = factor("Top")) %>%
  dplyr::group_by(Description, species) %>%
  dplyr::slice_max(order_by = species_CAI, prop = percentile) %>%
  dplyr::mutate(species = factor(species, levels = c("Ss", "Sr", "Sp", "Sv","Ce")))

tally(dat.Top)

dat.Bot <- species.specific.dat.df %>%
  # dplyr::filter(species != "Ce") %>%
  dplyr::mutate(Description = factor("Bot")) %>%
  dplyr::group_by(Description, species) %>%
  dplyr::slice_max(order_by = desc(species_CAI), prop = percentile) %>%
  dplyr::mutate(species = factor(species, levels = c("Ss", "Sr", "Sp", "Sv","Ce")))

tally(dat.Bot)

```
### Plot Relative CAI for Gene Sets  
This section/plot asks questions like: Are the most-codon-adapted *Strongyloides* genes less codon adapted relative to the *C. elegans* usage rules? Similarly, are the least-codon-adapted genes less codon adapted relative to the other usage rule. The goal of this is to try and understand whether there is likely to be overlap between  
```{r plotGOI}
tbl <- rbind(dat.Top, dat.Bot) %>%
  mutate(Description = recode(Description, Top = "Most-adapted genes",
                              Bot = "Least-adapted genes"))
# tbl <- pivot_longer(tbl,
#              cols = c("species_CAI", "outgroup_CAI"),
#              names_to = "value",
#              values_to = "CAI"
#              )
ggplot(tbl, aes(species,outgroup_CAI, Description)) +
  geom_jitter(mapping = aes(color = species), shape = 1) +
  facet_wrap( ~Description) +
  scale_color_hue (l = 40) +
  labs(y = "Codon bias relative to non-genus usage rules") +
  theme_bw() +
  theme(plot.title.position = "plot",
        plot.caption.position = "panel",
        plot.title = element_text(face = "bold",
                                  size = 8, hjust = 0),
        plot.subtitle = element_text(size = 8),
        legend.title = element_text(size = 8),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 8))


```



## GO Analysis: Top % Codon Adapted Genes
Take lists of the top percentile of codon adapted genes in each species, and run GO analysis to see if these genes are enriched for anything interesting.

```{r functionalEnrichmentTop}
# Carry out GO enrichment using gProfiler2 ----

run_GO <- function (data){
  GO.geneID <- data %>%
    ungroup() %>%
    group_by(species) %>%
    dplyr::group_map(~ {
      gost.res <- .x %>%
        dplyr::select(geneID, species_CAI) %>%
        unique() 
    }, .keep = TRUE)
  
  names(GO.geneID) <- levels(data$species)
  
  gost.results <- lapply(names(GO.geneID), function(y){
    organism = case_when (y == "Ss" ~ "ststerprjeb528",
                          y == "Sr" ~ "strattprjeb125",
                          y == "Sp" ~ "stpapiprjeb525",
                          y == "Sv" ~ "stveneprjeb530",
                          y == "Ce" ~ "caelegprjna13758")
    gost.res <- gost(GO.geneID[[y]]$geneID,
                     organism = organism, 
                     evcodes = TRUE,
                     correction_method = "fdr")
  })
  names(gost.results) <- names(GO.geneID)
  gost.results
}

find_enrichments <- function (gost.results) {
  # Find GO terms that are enriched with p-values equal or small than a threshold.
  enriched.terms <- lapply(names(gost.results), function(y){
    gost.results[[y]]$result %>%
      as_tibble() %>%
      dplyr::select(term_id, p_value)
  }) 
  names(enriched.terms) <- names(gost.results)
  enriched.terms
}

find_common_enrichments <- function (data, p.val,n_groups){
  data %>%
    dplyr::filter(p_value <= p.val) %>%
    group_by(term_id) %>%
    summarize(n= n()) %>%
    dplyr::filter(n >= n_groups)
}

gost.results.top <- run_GO(dat.Top)
enriched.terms.top <- find_enrichments(gost.results.top)
highTerms.overlap.top <- enriched.terms.top %>%
  bind_rows(.id = "species") %>%
  dplyr::filter(species != "Ce") %>%
  find_common_enrichments(.,0.001, 4)



```

### Interactive Manhattan Plots  
#### *S. stercoralis*
```{r}
gostplot(gost.results.top$Ss, interactive = T, capped = T) 
```

#### *S. ratti*
```{r}
gostplot(gost.results.top$Sr, interactive = T, capped = T) 
```

#### *S. papillosus*
```{r}
gostplot(gost.results.top$Sp, interactive = T, capped = T) 
```

#### *S. venezuelensis*
```{r}
gostplot(gost.results.top$Sv, interactive = T, capped = T) 
```

#### *C. elegans*
```{r}
gostplot(gost.results.top$Ce, interactive = T, capped = T) 
```

### Common GO Terms  
GO terms that are commonly enriched in the top percentile of codon adapted genes in all *Strongyloides* species tested:  
```{r}
dplyr::filter(gost.results.top$Ss$result, term_id %in% highTerms.overlap.top$term_id) %>%
  dplyr::select(term_id, term_name, intersection)
```

How many of the common *Strongyloides* go terms are found in the *C. elegans* terms?
```{r}
dplyr::filter(gost.results.top$Ce$result, term_id %in% highTerms.overlap.top$term_id) %>%
  dplyr::select(term_id, term_name)
```

How many are unique to the *Strongyloides* species?  
```{r}
temp <- dplyr::filter(highTerms.overlap.top, 
                      !term_id %in% gost.results.top$Ce$result$term_id)
dplyr::filter(gost.results.top$Ss$result, term_id %in% temp$term_id) %>%
  dplyr::select(term_id, term_name)
```

## GO Analysis: Bottom % Codon Adapted Genes
Take lists of the bottom percentile of codon adapted genes in each species, and run GO analysis to see if these genes are enriched for anything interesting.

```{r functionalEnrichmentBottom}
# Carry out GO enrichment using gProfiler2 ----
gost.results.bot <- run_GO(dat.Bot)
enriched.terms.bot <- find_enrichments(gost.results.bot)
highTerms.overlap.bot <- enriched.terms.bot %>%
  bind_rows(.id = "species") %>%
  dplyr::filter(species != "Ce") %>%
  find_common_enrichments(.,0.001, 4)

```

### Interactive Manhattan Plots  
#### *S. stercoralis*
```{r}
gostplot(gost.results.bot$Ss, interactive = T, capped = T) 
```

#### *S. ratti*
```{r}
gostplot(gost.results.bot$Sr, interactive = T, capped = T) 
```

#### *S. papillosus*
```{r}
gostplot(gost.results.bot$Sp, interactive = T, capped = T) 
```

#### *S. venezuelensis*
```{r}
gostplot(gost.results.bot$Sv, interactive = T, capped = T) 
```

#### *C. elegans*
```{r}
gostplot(gost.results.bot$Ce, interactive = T, capped = T) 
```

### Common GO Terms
GO terms that are commonly enriched in the bottom percentile of codon adapted genes in all *Strongyloides* species tested: 
```{r}
dplyr::filter(gost.results.bot$Ss$result, term_id %in% highTerms.overlap.bot$term_id) %>%
  dplyr::select(term_id, term_name)
```

How many of the common *Strongyloides* go terms are found in the *C. elegans* terms?
```{r}
dplyr::filter(gost.results.bot$Ce$result, term_id %in% highTerms.overlap.bot$term_id) %>%
  dplyr::select(term_id, term_name)
```

How many are unique to the *Strongyloides* species?  
```{r}
temp <- dplyr::filter(highTerms.overlap.bot, 
                      !term_id %in% gost.results.bot$Ce$result$term_id)
dplyr::filter(gost.results.bot$Ss$result, term_id %in% temp$term_id) %>%
  dplyr::select(term_id, term_name)
```

## Save Files and Plots  
Saving data and plots generated by the above code.  
```{r saveFiles, include=FALSE}

# Save distribution plot of codon adaptivness by species
ggsave('./Plots/Codon_Adaptiveness_Distributions_by_Species.pdf', 
       plot = species_adaptiveness_plot, 
       width = 5.5, height = 4, 
       units = "in", device = "pdf", 
       useDingbats = FALSE)

# Save distribution plot of GC content by species
ggsave('./Plots/GC_Distributions_by_Species.pdf', 
       plot = species_GC_plot, 
       width = 5.5, height = 4, 
       units = "in", device = "pdf", 
       useDingbats = FALSE)

write_excel <- function(data, sheet_facet, filename){
  
  file <- paste(filename,".xlsx",sep = "")
  # Workbook
  to_download <<- createWorkbook()
  
  sapply(seq_along(sheet_facet), function(x){
    addWorksheet(wb = to_download, sheetName = sheet_facet[[x]])
    
    sheet_data <- data %>%
      dplyr::filter(species == sheet_facet[[x]]) 
    # # Write Data
    # ## Sheet header
    # writeData(
    #   to_download,
    #   sheet = 1,
    #   x = c(
    #     paste0("Strongyloides Codon Usage Report"),
    #     paste0("Report generated on ", format(Sys.Date(), "%B %d, %Y"))
    #   )
    # )
    # 
    ## Results of codon usage analysis
    writeData(
      to_download,
      sheet = x,
      x = sheet_data,
      startRow = 1,
      startCol = 1,
      headerStyle = createStyle(
        textDecoration = "Bold",
        halign = "center",
        border = "bottom"
      )
    )
    
  })
  saveWorkbook(to_download, file, overwrite=TRUE)
}  

# Save files with top and bottom percentiles of codon adapted genes per species
tbl %>%
      dplyr::select(geneID, species_CAI, GC, Description, species) %>%
  write_excel(levels(tbl$species), 'Percentile_CAI_Genes')

# Save list of common GO terms for each species, and the genes id that intersect
# between the GO term and the query
# for the top and bottom percentile of codon adapted genes
a<-lapply(names(gost.results.bot), function(y){
  gost.results.bot[[y]]$result %>%
    dplyr::filter(term_id %in%  highTerms.overlap.bot$term_id) %>%
    as_tibble() %>%
    dplyr::select(-c(query, significant,parents)) %>%
    dplyr::arrange(p_value) %>%
    dplyr::mutate(species = y)
}) %>% bind_rows %>%
  dplyr::mutate(species = factor(species, levels = c("Ss", "Sr", "Sp", "Sv","Ce"))) %>%
  dplyr::mutate(Description = "Least-adapted genes")  %>%
  dplyr::relocate(Description,species,term_id, source, term_name, .before = everything()) 

b <- lapply(names(gost.results.top), function(y){
  gost.results.top[[y]]$result %>%
    dplyr::filter(term_id %in%  highTerms.overlap.top$term_id) %>%
    as_tibble() %>%
    dplyr::select(-c(query, significant,parents)) %>%
    dplyr::arrange(p_value) %>%
    dplyr::mutate(species = y)
}) %>% bind_rows %>%
  dplyr::mutate(species = factor(species, levels = c("Ss", "Sr", "Sp", "Sv","Ce"))) %>%
  dplyr::mutate(Description = "Most-adapted genes")  %>%
  dplyr::relocate(Description,species,term_id, source, term_name, .before = everything()) 

rbind(a,b) %>%
  write_excel(levels(a$species), 'Percentile_GO_Analysis')


# Save Functional Enrichment Plots for bottom percentile
lapply(names(gost.results.bot), function(y){
  gost.res <- gost.results.bot[[y]]
  
  gost.ggplot <- gostplot(gost.res, interactive = F, capped = T) +
    labs(title = paste(y, "Bottom", percentile*100,"% Codon Adapted Genes")) +
    theme(plot.title.position = "plot",
          plot.caption.position = "plot",
          plot.title = element_text(face = "bold",
                                    size = 8, hjust = 0))
  gost.ggplot.pub<- publish_gostplot(gost.ggplot,
                                     highlight_terms = highTerms.overlap.bot$term_id)
  ggsave(paste0('./Plots/',y,'_Bot_CAI_Plot.pdf'), plot = gost.ggplot.pub,
         width = 7, height = 4,
         units = "in", device = "pdf",
         useDingbats = FALSE)
  
})

# Save Functional Enrichment Plots for top percentile
lapply(names(gost.results.top), function(y){
  gost.res <- gost.results.top[[y]]
  
  gost.ggplot <- gostplot(gost.res, interactive = F, capped = T) +
    labs(title = paste(y, "Top", percentile*100,"% Codon Adapted Genes")) +
    theme(plot.title.position = "plot",
          plot.caption.position = "plot",
          plot.title = element_text(face = "bold",
                                    size = 8, hjust = 0))
  gost.ggplot.pub<- publish_gostplot(gost.ggplot,
                                     highlight_terms = highTerms.overlap.top$term_id)
  ggsave(paste0('./Plots/',y,'_Top_CAI_Plot.pdf'), plot = gost.ggplot.pub,
         width = 7, height = 5,
         units = "in", device = "pdf",
         useDingbats = FALSE)
  
})
```



\newpage
# Appendix: All code for this report  
```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
